\chapter{Конструкторский раздел}

\section{Алгоритм, использующий z-буфер}

Для реализации в программе был выбран алгоритм, использующий z-буфер, так как этот алгоритм способен обеспечить необходимую скорость работы.

Z-буфер является одним из простейших алгоритмов удаления невидимых поверхностей. Работает этот алгоритм в пространстве изображения. Идея z-буфера является простым обобщением идеи о буфере кадра. Буфер кадра используется для запоминания атрибутов (интенсивности) каждого пикселя в пространстве изображения, z-буфер --- это отдельный буфер глубины, используемый для запоминания координаты $z$ (глубины) каждого видимого пикселя в пространстве изображения. В процессе работы глубина или значение $z$ каждого нового пикселя, который нужно занести в буфер кадра, сравнивается с глубиной того пикселя, который уже занесен в z-буфер. Если это сравнение показывает, что новый пиксель расположен впереди пикселя, находящегося в буфере кадра, то новый пиксель заносится в этот буфер и, кроме того, производится корректировка z-буфера новым значением $z$. Если же сравнение дает противоположный результат, то никаких действий не производится. По сути, алгоритм является поиском по $x$ и $y$ наибольшего значения функции $Z(x, y)$. 

Алгоритм (рисунок \ref{img:z}):
\begin{enumerate}[label=\arabic*)]
    \item заполнение буфера кадра фоновый значением интенсивности (цвета);
    \item заполнение z-буфера минимальным значением $Z$;
    \item преобразование каждого многоугольника в растровую форму в произвольном порядке;
    \item вычисление для каждого пикселя с координатами $(x, y)$, принадлежащего многоугольнику, его глубины $Z(x, y)$;
    \item сравнение глубины $Z(x, y)$ со значением $Z_{\text{буф}}(x, y)$, которое хранится в z-буфере для пикселя с теми же координатами ($x$, $y$);
    \item запись атрибута очередного многоугольника в буфер кадра и замена $Z_{\text{буф}}(x, y)$ на значение $Z(x, y)$, если $Z(x, y)$>$Z_{\text{буф}}(x, y)$.
\end{enumerate}

\imgScale{0.65}{z}{Схема алгоритма z-буфера}
\FloatBarrier

Как уже было отмечено, главное преимущество алгоритма --- его простота. Так как габариты пространства изображения фиксированы, оценка вычис-лительной трудоемкости алгоритма не более чем линейна. Поскольку элементы сцены или картинки можно заносить в буфер кадра или в z-буфер в произвольном порядке, их не нужно предварительно сортировать по приоритету глубины. Поэтому экономится вычислительное время, затрачиваемое на сортировку по глубине.

\section{Модификация алгоритма, использующего \\z-буфер, для построения теней}

Модификация состоит из двух этапов.
\begin{enumerate}[label=\arabic*)]
    \item Строится сцена из точки, совпадающей с источником. Значения $z$ для этого ракурса хранятся в отдельном теневом z-буфере.
    \item Строится сцена из точки, в которой находится наблюдатель. При обработке каждой поверхности или многоугольника его глубина в каждом пикселе сравнивается с глубиной в z-буфере наблюдателя. Если поверхность видима, то значения $x$, $y$, $z$ из вида наблюдателя линейно преобразуются в значения $x'$, $y'$, $z'$ на виде из источника. Для того чтобы проверить, видимо ли значение $z'$ из положения источника, оно сравнивается со значением теневого z-буфера при $x'$, $y'$. Если оно видимо, то оно отображается в буфер кадра в точке $x$, $y$ без изменений. Если нет, то точка находится в тени и изображается согласно соответствующему правилу расчета интенсивности с учетом затенения, а значение в z-буфере наблюдателя заменяется на $z'$.
\end{enumerate}

На рисунках \ref{img:z_shadow1}--\ref{img:z_shadow2} представлен модифицированный алгоритм z-буфера для построения теней.

\imgScale{0.65}{z_shadow1}{Схема модифицированного алгоритма z-буфера для отображения теней (ч. 1)}
\imgScale{0.6}{z_shadow2}{Схема модифицированного алгоритма z-буфера для отображения теней (ч. 2)}
\clearpage

\section{Используемые типы и структуры данных для представления объектов}

В таблице \ref{tbl:types} представлены объекты, способ их представления в программе и типы и структуры данных для их описания.

\begin{table}[h]
\begin{center}
    % \begin{threeparttable}
    \captionsetup{justification=raggedleft}
    \caption{\label{tbl:types}Используемые типы и структуры данных}
    \begin{tabular}{|l|l|l|}
        \hline
        Данные & Представление & Тип\\
        \hline
        Точка в пространстве & Координаты точки по & Список типа $double$ \\ 
                             & трем осям     &                      \\ 
        \hline
        Грань & Номера задействованных & Список типа $int$ \\ 
              & вершин                 &                   \\ 
        \hline
        Полигональная        & Набор задействованных & Списки типа \\ 
        модель               & вершин и граней       & $Vertex$ (вершина) \\
                             &                       & и $Facet$ (грань) \\ 

        \hline
        Источник света & Углы по двум осям & Тип $int$ \\ 
        \hline
    \end{tabular}
    % \end{threeparttable}
\end{center}
\end{table}

\section{Описание используемых классов}

В результате разработки программы были реализованы следующие классы:
\begin{itemize}[label=---]
	\item \texttt{AddLight} — класс, предоставляющий интерфейс для добавления источника света на сцену.
	
	\item \texttt{BaseMotherboardConfig} — абстрактный класс, содержащий общую конфигурацию компонентов материнских плат.
	
	\item \texttt{ATXMotherboardConfig} — производный класс от базового класса \newline \texttt{BaseMotherboardConfig}, инкапсулирующий конфигурацию компонентов материнских плат формата ATX.
	
	\item \texttt{MicroATXMotherboardConfig} — производный класс от базового класса \newline \texttt{BaseMotherboardConfig}, инкапсулирующий конфигурацию компонентов материнских плат формата Micro-ATX.
	
	\item \texttt{MiniITXMotherboardConfig} — производный класс от базового класса \newline \texttt{BaseMotherboardConfig}, инкапсулирующий конфигурацию компонентов материнских плат формата Mini-ITX.
	
	\item \texttt{ConfigManager} — класс, описывающий совместимость внешних компонентов (модули оперативной памяти, видеокарты, процессоры) с различными форматами материнских плат.
	
	\item \texttt{CPUConfig} — класс, содержащий конфигурацию моделей процессоров.
	
	\item \texttt{SceneDrawer} — класс, ответственный за отрисовку сцены, управление буферами глубины и кадра.
	
	\item \texttt{Facade} — класс, реализующий фасадный паттерн для обеспечения взаимодействия пользователя с программными компонентами.
	
	\item \texttt{Facet} — класс, определяющий грань через список ее вершин.
	
	\item \texttt{GPUConfig} — класс, содержащий конфигурацию моделей видеокарт.
	
	\item \texttt{Light} — класс, описывающий источник света, включая его положение и параметры теневой карты.
	
	\item \texttt{Vertex} — класс, представляющий вершину. Хранит координаты вершины и список граней, в которых она участвует.
	
	\item \texttt{Dot3D} — класс для описания точки в трехмерном пространстве, хранящий ее координаты.
	
	\item \texttt{ObjectDelete} — класс, предоставляющий интерфейс для удаления внешних компонентов.
	
	\item \texttt{PolygonModel} — класс, хранящий полигональную модель, включая списки вершин и граней, а также информацию о размерах модели и ее положении на сцене.
	
	\item \texttt{SceneInf} — класс, содержащий информацию о текущем состоянии сцены: выбранный формат материнской платы, список интегрированных и добавленных пользователем компонентов, а также параметры освещения.
\end{itemize}


\section{Структура программного комплекса}

Программа должна обеспечить выполнение следующих функций:
\begin{itemize}[label=---]
	\item создание виртуальной сцены для моделирования и визуализации материнских плат;
	\item добавление на сцену компонентов материнских плат (процессора, видеокарт, модулей оперативной памяти) с возможностью выбора разъёма из распололежения;
	\item перемещение, поворот и масштабирование сцены с расположенными на ней компонентами;
	\item добавление источника света для отображения теней.
\end{itemize}

В интерфейсе программы должны присутствовать следующие модули:
\begin{enumerate}[label=\arabic*)]
	\item Модуль для отрисовки сцены:
	\begin{itemize}[label=---]
		\item выпадающий список для выбора формата материнской платы, позволяющий пользователю выбрать формат платы (ATX, Micro-ATX, Mini-ITX);
		\item кнопка для создания новой сцены, инициирующая процесс визуализации конфигурации  материнской платы выбранного формата;
		\item панель для отображения трехмерной модели материнской платы;
	\end{itemize}
	\item Модуль для работы с сценой:
	\begin{itemize}[label=---]
		\item инструменты для перемещения сцены;
		\item инструменты для поворота сцены;
		\item инструменты для масштабирования сцены.
	\end{itemize}
	\item Модуль для работы с объектами на сцене:
	\begin{itemize}[label=---]
		\item списки доступных компонентов (модулей оперативной памяти, видеокарт и процессоров), совместимых с выбранным форматом материнской платы;
		\item возможность выбора разъема для каждого компонента в зависимости от выбранного формата материнской платы для корректное расположение компонентов;
		\item кнопки для добавления компонентов на сцену и их удаления;
		\item инструменты для изменения цвета добавленных компонентов.
	\end{itemize}
\end{enumerate}

